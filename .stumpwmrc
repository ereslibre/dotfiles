;; -*- Mode: Lisp -*-

(in-package :stumpwm)

;; Set resolution related stuff
(if (getenv "LOW_DPI")
    (progn
      (setf (getenv "GDK_SCALE") "1")
      (setf (getenv "GDK_DPI_SCALE") "1")
      (run-shell-command "xrandr --dpi 96")
      (run-shell-command "xrdb ~/.Xresources.lowdpi"))
    (progn
      (setf (getenv "GDK_SCALE") "2")
      (setf (getenv "GDK_DPI_SCALE") "0.5")
      (run-shell-command "xrandr --dpi 220")
      (run-shell-command "xrdb ~/.Xresources.hidpi")))

(setf (getenv "QT_AUTO_SCREEN_SCALE_FACTOR") "1")
(setf (getenv "GDK_CORE_DEVICE_EVENTS") "1")

;; Include features from contrib
(load-module "cpu")
(load-module "wifi")
(load-module "ttf-fonts")

(setf wifi:*iwconfig-path* "/usr/sbin/iwconfig")

(if (getenv "LOW_DPI")
  (set-font (list (make-instance 'xft:font :family "Atari ST 8x16 System Font" :subfamily "Medium" :size 12)
                  (make-instance 'xft:font :family "FontAwesome" :subfamily "Regular" :size 12)))
  (set-font (list (make-instance 'xft:font :family "Atari ST 8x16 System Font" :subfamily "Medium" :size 22)
                  (make-instance 'xft:font :family "FontAwesome" :subfamily "Regular" :size 22))))

;; Do some initializations
(run-shell-command "killall redshift" t)
(run-shell-command "redshift -r &")
(run-shell-command "killall dunst" t)
(run-shell-command "dunst &")
(let*
    ((all-backgrounds (list-directory "~/.wallpapers"))
     (random-background (namestring (nth (random (length all-backgrounds)) all-backgrounds))))
  (run-shell-command (concat "feh --bg-scale " random-background)))
(run-shell-command "xsetroot -cursor_name left_ptr")
(run-shell-command "xscreensaver &")

;; Modeline

(defun set-keyboard-layout (layout)
  (setf *keyboard-layout* layout)
  (run-shell-command (concat "setxkbmap " layout)))
(set-keyboard-layout "en_US")
(defcommand rr-keyboard-layout () ()
  (if (string-equal *keyboard-layout* "es")
      (set-keyboard-layout "en_US")
      (set-keyboard-layout "es")))

(defun set-brightness (brightness)
  (setf *brightness* brightness)
  (run-shell-command (concat "xbacklight -set " brightness)))

(set-brightness "15")

(defcommand raise-brightness () ()
  (setf new-brightness (+ (parse-integer *brightness*) 5))
  (set-brightness (write-to-string new-brightness)))

(defcommand lower-brightness () ()
  (setf new-brightness (- (parse-integer *brightness*) 5))
  (set-brightness (write-to-string new-brightness)))

(setf *muted* (run-shell-command "pactl list sinks | grep Mute | awk '{print $2}' | tr -d '\\r\\n'" t))
(setf *volume* (run-shell-command "pactl list sinks | grep -i volume | head -n1 | awk '{print $5}' | tr -d '\\r\\n'" t))
(defun volume-info ()
  (if (string-equal *muted* "yes")
    (concat "^f1^f0 " *volume*)
    (concat "^f1^f0 " *volume*)))

(defcommand raise-volume () ()
  (run-shell-command "pactl set-sink-volume 0 +5%")
  (setf *volume* (run-shell-command "pactl list sinks | grep -i volume | head -n1 | awk '{print $5}' | tr -d '\\r\\n'" t))
  nil)

(defcommand lower-volume () ()
  (run-shell-command "pactl set-sink-volume 0 -5%")
  (setf *volume* (run-shell-command "pactl list sinks | grep -i volume | head -n1 | awk '{print $5}' | tr -d '\\r\\n'" t))
  nil)

(defcommand toggle-mute () ()
  (run-shell-command "pactl set-sink-mute 0 toggle")
  (setf *muted* (run-shell-command "pactl list sinks | grep Mute | awk '{print $2}' | tr -d '\\r\\n'" t))
  nil)

(defun battery-status ()
  (let* ((status (run-shell-command "cat /sys/class/power_supply/BAT0/status | tr -d '\\r\\n'" t))
         (capacity (cond ((< (parse-integer (battery-capacity)) 5) "^f1^f0")
                         ((< (parse-integer (battery-capacity)) 10) "^f1^f0")
                         ((< (parse-integer (battery-capacity)) 60) "^f1^f0")
                         ((< (parse-integer (battery-capacity)) 80) "^f1^f0")
                         (T "^f1^f0"))))
  (if (string-equal status "Discharging")
    capacity
    (concat "^f1^f0 " capacity))))

(defun battery-capacity ()
  (run-shell-command "cat /sys/class/power_supply/BAT0/capacity | tr -d '\\r\\n'" t))

(setf *startup-message* nil)
(setf *mode-line-timeout* 1)
(if (not (head-mode-line (current-head)))
    (toggle-mode-line (current-screen) (current-head)))

(setf *message-window-padding* 5)

(set-focus-color   "lightskyblue4")
(set-unfocus-color "gray6")
(set-win-bg-color  "gray8")

(set-fg-color "oldlace")
(set-bg-color "gray8")
(set-border-color "oldlace")

(setf *time-modeline-string* "^f1^f0 %a, %e %b | ^f1^f0 %H:%M")

(setf *mode-line-foreground-color* "white"
      *mode-line-background-color* "black"
      *mode-line-border-color*     "oldlace"
      *mode-line-position*         :top)

(mode-line) (mode-line)

(setf *screen-mode-line-format*
      (list "^B[ %n ]^b [ %W ]"
            "^>"
            "^7*"
            "^f1^f0 %I | "
            "^f1^f0 %c | "
            "^f1^f0 " '(:eval *keyboard-layout*) " | "
                        '(:eval (volume-info)) " | "
            "^f1^f0 " '(:eval *brightness*) "% | "
                        '(:eval (battery-status)) " "
                        '(:eval (battery-capacity)) "% | "
            "%d"
            ))

;; Defaults

(setf *group-format* "%s [%n] %t ")
(setf *window-format* "%m%n%s%c")
(setf *message-window-gravity* :top-right)
(setf *input-window-gravity* :top-right)
(setf *ignore-wm-inc-hints* t)
(setf *window-border-style* :thin)
(setf *timeout-wait* 5)
(setf *mouse-focus-policy* :click)

;; Shortcuts

(define-key *top-map* (kbd "C-Q") "quit")
(define-key *top-map* (kbd "C-Return") "exec gnome-terminal")

(define-key *top-map* (kbd "M-n") "pull-hidden-next")
(define-key *top-map* (kbd "M-p") "pull-hidden-previous")
(define-key *top-map* (kbd "M-N") "gnext")
(define-key *top-map* (kbd "M-P") "gprev")

(define-key *top-map* (kbd "M-z") "rr-keyboard-layout")

(define-key *root-map* (kbd "M-l") "exec xscreensaver-command --lock")

(define-key *root-map* (kbd "d") "exec dmenu_run -fn 'Atari ST 8x16 System Font-12' -p 'What you up to?' -m 0")

(define-key *root-map* (kbd "e") "exec GDK_SCALE=1 GDK_DPI_SCALE=1 emacs")
(define-key *root-map* (kbd "C-e") "exec GDK_SCALE=1 GDK_DPI_SCALE=1 emacs")

(define-key *root-map* (kbd "C-m") "exec geary")
(define-key *root-map* (kbd "c") "exec chromium")
(define-key *root-map* (kbd "C-c") "exec chromium")
(define-key *root-map* (kbd "C-s") "exec nautilus")
(define-key *root-map* (kbd "C-q") "exec quasselclient")
(define-key *root-map* (kbd "C-i") "exec telegram-desktop")

(define-key *root-map* (kbd "C-n") "move-focus down")
(define-key *root-map* (kbd "C-p") "move-focus up")
(define-key *root-map* (kbd "C-f") "move-focus right")
(define-key *root-map* (kbd "C-b") "move-focus left")

(define-key *root-map* (kbd "M-p") "move-window up")
(define-key *root-map* (kbd "M-b") "move-window left")
(define-key *root-map* (kbd "M-n") "move-window down")
(define-key *root-map* (kbd "M-f") "move-window right")

;; Create default groups

(run-commands "grename code" "gnewbg terminals" "gnewbg www" "gnewbg im" "gnewbg mail" "gnewbg media")

;; Deal with special keys

(define-key *top-map* (kbd "XF86AudioRaiseVolume") "raise-volume")
(define-key *top-map* (kbd "XF86AudioLowerVolume") "lower-volume")
(define-key *top-map* (kbd "XF86AudioMute") "toggle-mute")
(define-key *top-map* (kbd "XF86MonBrightnessUp") "raise-brightness")
(define-key *top-map* (kbd "XF86MonBrightnessDown") "lower-brightness")

;; Give priority to ~/bin when calling to StumpWM's exec

(setf (getenv "PATH") (concat "~/bin:" (getenv "PATH")))

;; Default apps

(setf (getenv "EDITOR") "emacs -nw -q")
(setf (getenv "BROWSER") "chromium")

;; Add commands

(defcommand hdpi(command)
  ((:string "Execute command with HiDPI: "))
  "docstring"
  (check-type command string)
  (run-or-raise
   (concat "hidpi " command)
   '(:class "HiDPI")))

(defcommand wp (search)
  ((:string "Search in Wikipedia for: "))
  "docstring"
  (check-type search string)
  (run-or-raise
     (concat "chromium https://en.wikipedia.org/wiki/Special:Search?search=" (substitute #\+ #\Space search))
     '(:class "Wikipedia")))

(defcommand gg (search)
  ((:string "Search in Google for: "))
  "docstring"
  (check-type search string)
  (run-or-raise
     (concat "chromium https://www.google.com/search?q=" (substitute #\+ #\Space search))
     '(:class "Google")))

;; Add extra maps

(setf *display-map*
  (let ((m (make-sparse-keymap)))
    (define-key m (kbd "l") "laptop-only")
    (define-key m (kbd "f") "external-right")
    (define-key m (kbd "b") "external-left")
    m))

(defcommand laptop-only () ()
  (run-shell-command "xrandr --output eDP1 --auto --primary --output DP1 --off --output DP2 --off --output HDMI1 --off --output HDMI2 --off --output VIRTUAL1 --off")
  (restart-soft))

(defcommand external-right () ()
  (run-shell-command "xrandr --output eDP1 --auto --output DP1 --primary --right-of eDP1 --auto --output DP2 --off --output HDMI1 --off --output HDMI2 --off --output VIRTUAL1 --off")
  (restart-soft))

(defcommand external-left () ()
  (run-shell-command "xrandr --output eDP1 --auto --output DP1 --primary --left-of eDP1 --auto --output DP2 --off --output HDMI1 --off --output HDMI2 --off --output VIRTUAL1 --off")
  (restart-soft))

(define-key *root-map* (kbd "C-d") '*display-map*)
