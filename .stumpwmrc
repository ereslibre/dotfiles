;; -*- Mode:p Lisp -*-

(in-package :stumpwm)

;; Include nice fonts

(load-module "ttf-fonts")
(set-font (make-instance 'xft:font :family "mononoki" :subfamily "Regular" :size 22))

;; Do some initializations

(run-shell-command "xrdb -merge ~/.Xresources")
(run-shell-command "feh --bg-scale ~/.wallpapers/2.jpg")
(run-shell-command "xsetroot -cursor_name left_ptr")
(run-shell-command "xmodmap ~/.Xmodmap")
(run-shell-command "xscreensaver -no-splash")
(run-shell-command "/usr/lib/gnome-settings-daemon/gnome-settings-daemon &")

;; Modeline

(defun set-keyboard-layout (layout)
  (setq *keyboard-layout* layout)
  (run-shell-command (concat "setxkbmap " layout)))
(set-keyboard-layout "en_US")
(defcommand rr-keyboard-layout () ()
  (if (string-equal *keyboard-layout* "es")
      (set-keyboard-layout "en_US")
      (set-keyboard-layout "es")))

(defun set-brightness (brightness)
  (setq *brightness* brightness)
  (run-shell-command (concat "sudo su -c 'echo " brightness " > /sys/class/backlight/intel_backlight/brightness'")))
(set-brightness "100")

(defcommand raise-brightness () ()
  (setq new-brightness (+ (parse-integer *brightness*) 10))
  (set-brightness (write-to-string new-brightness)))

(defcommand lower-brightness () ()
  (setq new-brightness (- (parse-integer *brightness*) 10))
  (set-brightness (write-to-string new-brightness)))

(setf *muted* (run-shell-command "pactl list sinks | grep Mute | awk '{print $2}' | tr -d '\\r\\n'" t))
(setf *volume* (run-shell-command "pactl list sinks | grep -i volume | head -n1 | awk '{print $5}' | tr -d '\\r\\n'" t))
(defun volume-info ()
  (if (string-equal *muted* "yes")
    (concat "~" *volume*)
    *volume*))

(defcommand raise-volume () ()
  (run-shell-command "pactl set-sink-volume 0 +5%")
  (setf *volume* (run-shell-command "pactl list sinks | grep -i volume | head -n1 | awk '{print $5}' | tr -d '\\r\\n'" t))
  nil)

(defcommand lower-volume () ()
  (run-shell-command "pactl set-sink-volume 0 -5%")
  (setf *volume* (run-shell-command "pactl list sinks | grep -i volume | head -n1 | awk '{print $5}' | tr -d '\\r\\n'" t))
  nil)

(defcommand toggle-mute () ()
  (run-shell-command "pactl set-sink-mute 0 toggle")
  (setf *muted* (run-shell-command "pactl list sinks | grep Mute | awk '{print $2}' | tr -d '\\r\\n'" t))
  nil)

(defun battery-status ()
  (run-shell-command "cat /sys/class/power_supply/BAT0/status | tr -d '\\r\\n'" t))

(defun battery-capacity ()
  (run-shell-command "cat /sys/class/power_supply/BAT0/capacity | tr -d '\\r\\n'" t))

(setf *startup-message* nil)
(setf *mode-line-timeout* 60)
(if (not (head-mode-line (current-head)))
    (toggle-mode-line (current-screen) (current-head)))

(setf *screen-mode-line-format*
      (list "[^B%n^b] %W"
            "^>"
            "^7*"
            " [" '(:eval *keyboard-layout*) "]"
            " [" '(:eval (volume-info)) "]"
            " [" '(:eval *brightness*) "]"
            " [" '(:eval (battery-status)) "|"
                 '(:eval (battery-capacity)) "%]"
            ))

;; Defaults

(setf *group-format* "%s [%n] %t ")
(setf *window-format* "%m%n%s%c")
(setf *message-window-gravity* :top-right)
(setf *input-window-gravity* :top-right)
(setq *ignore-wm-inc-hints* t)
(setq *window-border-style* :thin)
(setf *timeout-wait* 5)
(setf *mouse-focus-policy* :click)

;; Shortcuts

(define-key *top-map* (kbd "C-Q") "quit")
(define-key *top-map* (kbd "C-Return") "exec terminator")

(define-key *top-map* (kbd "M-n") "pull-hidden-next")
(define-key *top-map* (kbd "M-p") "pull-hidden-previous")
(define-key *top-map* (kbd "M-N") "gnext")
(define-key *top-map* (kbd "M-P") "gprev")

(define-key *top-map* (kbd "M-z") "rr-keyboard-layout")

(define-key *root-map* (kbd "M-l") "exec xscreensaver-command --lock")

(define-key *root-map* (kbd "c") "exec terminator")
(define-key *root-map* (kbd "C-c") "exec terminator")

(define-key *root-map* (kbd "e") "exec GDK_SCALE=1 GDK_DPI_SCALE=1 emacs")
(define-key *root-map* (kbd "C-e") "exec GDK_SCALE=1 GDK_DPI_SCALE=1 emacs")

(define-key *root-map* (kbd "M-m") "exec geary")
(define-key *root-map* (kbd "M-c") "exec chromium")
(define-key *root-map* (kbd "M-g") "exec nautilus")
(define-key *root-map* (kbd "M-q") "exec quasselclient")
(define-key *root-map* (kbd "M-i") "exec telegram-desktop")

(define-key *root-map* (kbd "C-n") "move-focus down")
(define-key *root-map* (kbd "C-p") "move-focus up")
(define-key *root-map* (kbd "C-f") "move-focus right")
(define-key *root-map* (kbd "C-b") "move-focus left")

(define-key *root-map* (kbd "M-p") "move-window up")
(define-key *root-map* (kbd "M-b") "move-window left")
(define-key *root-map* (kbd "M-n") "move-window down")
(define-key *root-map* (kbd "M-f") "move-window right")

;; Create default groups

(run-commands "grename code" "gnewbg www" "gnewbg im" "gnewbg mail" "gnewbg media")

;; Deal with special keys

(define-key *top-map* (kbd "XF86AudioRaiseVolume") "raise-volume")
(define-key *top-map* (kbd "XF86AudioLowerVolume") "lower-volume")
(define-key *top-map* (kbd "XF86AudioMute") "toggle-mute")
(define-key *top-map* (kbd "XF86MonBrightnessUp") "raise-brightness")
(define-key *top-map* (kbd "XF86MonBrightnessDown") "lower-brightness")

;; Give priority to ~/bin when calling to StumpWM's exec

(setf (getenv "PATH") (concat "~/bin:" (getenv "PATH")))
