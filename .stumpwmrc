;; -*- Mode:p Lisp -*-

(in-package :stumpwm)

;; Do some initializations

(run-shell-command "xscreensaver -no-splash")

;; Modeline

(defun volume-info ()
  "Get current volume"
  (let ((muted (run-shell-command "pactl list sinks | grep Mute | awk '{print $2}' | tr -d '\\r\\n'" t))
        (volume (run-shell-command "pactl list sinks | grep -i volume | head -n1 | awk '{print $5}' | tr -d '\\r\\n'" t)))
    (if (string-equal muted "yes")
        "-"
        volume)))

(defun battery-status ()
  "Get battery status"
  (run-shell-command "cat /sys/class/power_supply/BAT0/status | tr -d '\\r\\n'" t))

(defun battery-capacity ()
  "Get battery capacity"
  (run-shell-command "cat /sys/class/power_supply/BAT0/capacity | tr -d '\\r\\n'" t))

(setf *startup-message* nil)
(setf *mode-line-timeout* 60)
(if (not (head-mode-line (current-head)))
    (toggle-mode-line (current-screen) (current-head)))

(setf *screen-mode-line-format*
      (list "[^B%n^b] %W"
            "^>"
            "^7*"
            " S[" '(:eval (volume-info)) "]"
            " B[" '(:eval (battery-status)) "|"
                  '(:eval (battery-capacity)) "%]"
            ))

;; Defaults

(setf *group-format* "%s [%n] %t ")
(setf *window-format* "%m%n%s%c")
(setf *message-window-gravity* :top-right)
(setf *input-window-gravity* :top-right)
(setq *ignore-wm-inc-hints* t)
(setq *window-border-style* :thin)
(setf *timeout-wait* 5)
(setf *mouse-focus-policy* :click)

;; Shortcuts

(define-key *top-map* (kbd "C-Q") "quit")
(define-key *top-map* (kbd "C-Return") "exec terminator")

(define-key *top-map* (kbd "M-n") "pull-hidden-next")
(define-key *top-map* (kbd "M-p") "pull-hidden-previous")
(define-key *top-map* (kbd "M-N") "gnext")
(define-key *top-map* (kbd "M-P") "gprev")

(define-key *root-map* (kbd "M-l") "exec xscreensaver-command --lock")

(define-key *root-map* (kbd "c") "exec terminator")
(define-key *root-map* (kbd "C-c") "exec terminator")

(define-key *root-map* (kbd "M-m") "exec geary")
(define-key *root-map* (kbd "M-c") "exec chromium")
(define-key *root-map* (kbd "M-g") "exec nautilus")
(define-key *root-map* (kbd "M-q") "exec quasselclient")
(define-key *root-map* (kbd "M-i") "exec telegram-desktop")

(define-key *root-map* (kbd "C-n") "move-focus down")
(define-key *root-map* (kbd "C-p") "move-focus up")
(define-key *root-map* (kbd "C-f") "move-focus right")
(define-key *root-map* (kbd "C-b") "move-focus left")

(define-key *root-map* (kbd "M-p") "move-window up")
(define-key *root-map* (kbd "M-b") "move-window left")
(define-key *root-map* (kbd "M-n") "move-window down")
(define-key *root-map* (kbd "M-f") "move-window right")

;; Create default groups

(run-commands "grename code" "gnewbg www" "gnewbg im" "gnewbg mail" "gnewbg media")

;; Deal with special keys

(define-key *top-map* (kbd "XF86AudioRaiseVolume") "exec pactl set-sink-volume 0 +5%")
(define-key *top-map* (kbd "XF86AudioLowerVolume") "exec pactl set-sink-volume 0 -5%")
(define-key *top-map* (kbd "XF86AudioMute") "exec pactl set-sink-mute 0 toggle")
